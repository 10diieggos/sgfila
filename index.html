<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Senhas por Prioridade - Correios</title>
    <script src="jquery-3.6.0.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: linear-gradient(135deg, #004a8d, #0066cc);
            color: white;
            padding: 20px;
            text-align: center;
            border-radius: 10px 10px 0 0;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        /* --- REMOVIDO: .guiche-bar (Movido para Configurações) --- */
        
        .dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s;
        }
        
        .card:hover {
            transform: translateY(-5px);
        }
        
        /* --- ALTERADO: #senha-atual agora é um container --- */
        #guiche-control-panels {
            display: flex;
            flex-direction: column;
            gap: 15px;
            /* margin-bottom: 20px; */ /* Movido para .secao-painel */
        }

        .guiche-painel {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
        }

        /* --- MODIFICADO: Estilo do nome do guichê ajustado para ficar DENTRO do painel tracejado --- */
        .guiche-painel-nome {
            display: block;
            font-weight: bold;
            color: #004a8d;
            margin-bottom: 5px; /* Reduzido */
            font-size: 1.1rem;
            border-bottom: none; /* Removido */
            padding-bottom: 0; /* Removido */
        }

        /* --- MODIFICADO: O painel tracejado agora tem a fonte principal removida (movida para o filho) --- */
        .senha-atual-guiche {
            text-align: center;
            /* font-size: 3rem; */ /* MOVIDO para .senha-numero */
            font-weight: bold;
            color: #004a8d;
            margin: 10px 0;
            padding: 10px;
            border-radius: 8px;
            background-color: #f0f8ff;
            border: 2px dashed #004a8d;
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s;
        }

        .senha-atual-guiche.prioridade {
            background-color: #fff5f5;
            border-color: #ff6b6b;
            color: #c92a2a;
        }
        .senha-atual-guiche.contratual {
            background-color: #f3e8ff;
            border-color: #845ef7;
            color: #7048e8;
        }
        .senha-atual-guiche.normal {
            /* Padrão */
        }

        /* --- NOVO: Classes para o número e o placeholder '---' --- */
        .senha-numero {
            font-size: 3rem;
            font-weight: bold;
            color: inherit; /* Herda a cor (vermelho/roxo/azul) do pai */
            line-height: 1.1;
        }
        
        .senha-numero.vazio {
            color: #adb5bd; /* A cor do '---' original */
        }
        /* --- FIM DA MODIFICAÇÃO --- */


        .senha-atual-guiche:empty::after,
        .senha-atual-guiche:hover:empty::after {
            /* Este seletor pode não funcionar mais como esperado, 
               mas é mantido para consistência. A lógica JS agora 
               controla o '---'. */
            content: '---';
            color: #adb5bd;
            background-color: transparent;
        }

        /* --- FIM DAS ALTERAÇÕES --- */

        .senha-atual + .fila {
            margin-bottom: 20px; 
        }
        
        .controls {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        /* --- MODIFICADO: Req 1 (Botões de Emissão) --- */
        button {
            padding: 10px 13px;
            border: 2px solid transparent; /* Alterado de 'none' */
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        button i {
            font-size: 1.2rem;
        }

        button:disabled {
            background-color: #ced4da;
            color: #868e96;
            cursor: not-allowed;
            transform: none;
        }
        
        /* --- MODIFICADO: Req 1 (Botões de Emissão) --- */
        .btn-prioridade {
            background-color: #ffffff;
            color: #ff6b6b;
            border-color: #ff6b6b;
        }
        
        /* --- MODIFICADO: Req 1 (Botões de Emissão) --- */
        .btn-prioridade:hover {
            background-color: #fff5f5;
            color: #ff5252;
            border-color: #ff5252;
            transform: scale(1.05);
        }
        
        /* --- MODIFICADO: Req 1 (Botões de Emissão) --- */
        .btn-normal {
            background-color: #ffffff;
            color: #4dabf7;
            border-color: #4dabf7;
        }
        
        /* --- MODIFICADO: Req 1 (Botões de Emissão) --- */
        .btn-normal:hover {
            background-color: #e7f5ff;
            color: #339af0;
            border-color: #339af0;
            transform: scale(1.05);
        }

        /* --- MODIFICADO: Req 1 (Botões de Emissão) --- */
        .btn-contratual {
            background-color: #ffffff;
            color: #845ef7;
            border-color: #845ef7;
        }
        
        /* --- MODIFICADO: Req 1 (Botões de Emissão) --- */
        .btn-contratual:hover {
            background-color: #f3e8ff;
            color: #7048e8;
            border-color: #7048e8;
            transform: scale(1.05);
        }
        
        .btn-reiniciar {
            background-color: #ff8787;
            color: white;
        }
        
        .btn-reiniciar:hover {
            background-color: #fa5252;
            transform: scale(1.05);
        }
        
        .fila {
            margin-top: 15px;
        }
        
        .fila h3 {
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 2px solid #eee;
            color: #004a8d;
        }
        
        .ratio-control {
            margin-top: 15px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #eee;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .ratio-control + .ratio-control {
            margin-top: 0;
            padding-top: 0;
            margin-bottom: 20px;
            border-top: none;
        }
        
        .ratio-control label {
            font-weight: bold;
            margin-bottom: 0;
            color: #004a8d;
        }
        
        .ratio-control input {
            width: 60px;
            padding: 5px;
            text-align: center;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: bold;
        }
        
        .ratio-control span {
            font-weight: bold;
            color: #495057;
            font-size: 1rem;
        }

        /* --- NOVOS ESTILOS DE FILTRO --- */
        .filtro-fila-wrapper {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            flex-wrap: wrap; /* Para telas menores */
            gap: 10px;
        }
        
        .filtro-botoes {
            display: flex;
            gap: 5px;
            flex-grow: 1;
        }

        .btn-filtro {
            padding: 5px 10px;
            border: 1px solid #ccc;
            background-color: #f8f9fa;
            color: #555;
            font-size: 0.85rem;
            font-weight: normal; /* Sobrescreve o 'bold' geral de 'button' */
            border-radius: 5px;
            cursor: pointer;
            gap: 4px; /* Menor espaçamento */
        }
        
        .btn-filtro i {
            font-size: 0.9rem; /* Ícones menores */
        }

        .btn-filtro:hover {
            background-color: #e9ecef;
        }

        .btn-filtro.active {
            background-color: #004a8d;
            color: white;
            border-color: #004a8d;
            font-weight: bold;
        }

        .filtro-busca-wrapper {
            display: flex;
            align-items: center;
            border: 1px solid #ccc;
            border-radius: 5px;
            background-color: white;
            padding: 0 8px;
        }
        
        .filtro-busca-wrapper i {
            color: #aaa;
            font-size: 0.9rem;
        }

        #filtro-busca {
            border: none;
            padding: 6px 4px 6px 8px;
            font-size: 0.9rem;
            outline: none;
            background: transparent;
        }
        /* --- FIM: NOVOS ESTILOS DE FILTRO --- */

        .lista-senhas {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
            background-color: #f8f9fa;
        }

        #lista-espera .senha-item {
            cursor: default;
        }
        
        .senha-item {
            padding: 10px 12px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 6px;
            margin-bottom: 5px;
            transition: background-color 0.2s;
        }
        
        .senha-item:hover {
            background-color: #e9ecef;
        }
        
        .senha-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        
        .senha-item.prioridade {
            background-color: #fff5f5;
            border-left: 4px solid #ff6b6b;
        }
        
        .senha-item.normal {
            background-color: #f8f9fa;
            border-left: 4px solid #4dabf7;
        }
        
        .senha-item.contratual {
            background-color: #f3e8ff;
            border-left: 4px solid #845ef7;
        }
        
        .senha-item.atual {
            background-color: #e7f5ff;
            font-weight: bold;
            border: 2px solid #339af0;
        }
        
        .senha-item.chamada {
            background-color: #fff3cd;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { background-color: #fff3cd; }
            50% { background-color: #ffeaa7; }
            100% { background-color: #fff3cd; }
        }
        
        /* --- MODIFICADO: Req 3 (Rótulos de Fila) - Ocultando os badges --- */
        .badge {
            /* display: none; */ /* Ocultado via JS (Req 3) */
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: bold;
            color: white;
        }
        
        .badge-prioridade {
            background-color: #ff6b6b;
        }
        
        .badge-normal {
            background-color: #4dabf7;
        }

        .badge-contratual {
            background-color: #845ef7;
        }

        /* --- Estilos para botões de ação na fila --- */
        .senha-item-controles {
            display: flex;
            align-items: center; 
            gap: 10px; 
        }

        .senha-item-controles .botoes-wrapper {
            display: flex;
            gap: 6px; 
        }
        
        /* --- NOVO: Estilo wrapper para botões de ação (usado no ticket info) --- */
        .botoes-wrapper {
            display: flex;
            gap: 6px; 
        }
        /* --- FIM --- */

        /* --- MODIFICADO: Req 4 (Botões de Ação da Fila) --- */
        .btn-acao-senha {
            padding: 3px 6px; /* Tamanho diminuído */
            border: 1px solid; /* Borda adicionada */
            background-color: transparent; /* Fundo transparente */
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s;
        }

        /* --- MODIFICADO: Req 4 --- */
        .btn-acao-chamar {
            color: #51cf66;
            border-color: #51cf66;
        }
        /* --- MODIFICADO: Req 4 --- */
        .btn-acao-chamar:hover {
            background-color: #51cf66;
            color: white;
        }

        /* --- MODIFICADO: Req 4 --- */
        .btn-acao-excluir {
            color: #ff6b6b;
            border-color: #ff6b6b;
        }
        /* --- MODIFICADO: Req 4 --- */
        .btn-acao-excluir:hover {
            background-color: #ff6b6b;
            color: white;
        }
        
        /* --- MODIFICADO: Req 4 --- */
        .btn-acao-editar {
            color: #4dabf7;
            border-color: #4dabf7;
        }
        /* --- MODIFICADO: Req 4 --- */
        .btn-acao-editar:hover {
            background-color: #4dabf7;
            color: white;
        }

        /* --- MODIFICADO: Req 4 --- */
        .btn-acao-info {
            color: #17a2b8;
            border-color: #17a2b8;
        }
        /* --- MODIFICADO: Req 4 --- */
        .btn-acao-info:hover {
            background-color: #17a2b8;
            color: white;
        }

        /* --- NOVO: Estilo para botão devolver --- */
        .btn-acao-devolver {
            color: #fd7e14;
            border-color: #fd7e14;
        }
        /* --- NOVO --- */
        .btn-acao-devolver:hover {
            background-color: #fd7e14;
            color: white;
        }
        /* --- FIM: Estilos para botões de ação na fila --- */

        .senha-item-descricao {
            font-size: 0.85rem;
            color: #495057;
            margin-left: 22px; 
            font-style: italic;
        }

        
        .stats {
            margin-top: 20px;
        }
        
        .stat-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }
        
        .stat-item:last-child {
            border-bottom: none;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal-content {
            background-color: white;
            padding: 25px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .close {
            font-size: 1.5rem;
            cursor: pointer;
            color: #868e96;
        }
        
        .close:hover {
            color: #495057;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #495057;
        }

        textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 1rem;
            resize: vertical;
        }
        
        .prioridade-options {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
        }
        
        .prioridade-option {
            padding: 12px 15px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .prioridade-option:hover {
            border-color: #4dabf7;
            background-color: #f8f9fa;
        }
        
        .prioridade-option.selected {
            border-color: #339af0;
            background-color: #e7f5ff;
        }
        
        .prioridade-option i {
            font-size: 1.5rem;
            color: #339af0;
        }
        
        .prioridade-descricao {
            font-size: 0.9rem;
            color: #868e96;
            margin-top: 5px;
        }
        
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            background-color: #fff3cd;
            border-left: 4px solid #ffc107;
        }
        
        .controls-modal-reiniciar {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 25px;
        }
        
        .controls-modal-reiniciar button {
            font-size: 1.2rem;
            padding: 15px 20px;
        }

        .btn-reiniciar-confirmar {
            background-color: #fa5252;
            color: white;
        }
        .btn-reiniciar-confirmar:hover {
            background-color: #e03131;
        }
        
        .btn-cancelar {
            background-color: #868e96;
            color: white;
        }
        .btn-cancelar:hover {
            background-color: #5c6770;
        }
        
        .modal-clicavel-fechar {
            justify-content: center;
            align-items: center;
            cursor: pointer;
        }
        
        .modal-content-nova-senha {
            background-color: white;
            padding: 40px 60px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            cursor: default;
            width: 90%;
            max-width: 500px;
        }
        
        .modal-content-nova-senha span {
            display: block;
            font-size: 2rem;
            color: #495057;
            margin-bottom: 10px;
        }
        
        #senha-gerada-numero {
            font-size: 7rem;
            font-weight: bold;
            color: #004a8d;
            line-height: 1.1;
        }

        .form-group-modal-senha {
            margin-top: 20px;
            text-align: left;
            display: none; 
        }

        .form-group-modal-senha label {
            font-size: 0.9rem;
            color: #495057;
        }

        .controls-modal-editar {
            display: flex;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .btn-salvar-descricao {
            background-color: #51cf66;
            color: white;
            padding: 10px 20px;
        }
        .btn-salvar-descricao:hover {
            background-color: #40c057;
        }

        /* --- NOVOS ESTILOS DAS ABAS --- */
        .tab-nav {
            display: flex;
            border-bottom: 2px solid #eee;
            margin-bottom: 20px;
        }
        
        .tab-link {
            padding: 10px 15px;
            cursor: pointer;
            border: none;
            background-color: transparent;
            font-size: 1rem;
            font-weight: bold;
            color: #868e96;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px; /* Alinha com a borda principal */
            transition: all 0.2s;
            flex-grow: 1; /* Faz as abas ocuparem espaço igual */
            text-align: center;
        }
        
        .tab-link:hover {
            color: #495057;
            background-color: #f8f9fa;
        }
        
        .tab-link.active {
            color: #004a8d; /* Cor principal do tema */
            border-bottom: 3px solid #004a8d;
        }

        .tab-content {
            display: none; /* Esconde por padrão */
        }
        
        .tab-content.active {
            display: block; /* Mostra o ativo */
        }

        /* Ajustes de espaçamento para o conteúdo movido */
        .tab-content h2 {
            font-size: 1.5rem;
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 5px;
            border-bottom: 2px solid #eee;
        }
        /* --- NOVO: Título h3 para seções de config --- */
        .tab-content h3 {
            font-size: 1.2rem;
            color: #004a8d;
            margin-bottom: 10px;
        }
        .tab-content .stats {
            margin-top: 0;
        }
        .tab-content .fila {
            margin-top: 0;
        }
        .tab-content .ratio-control {
            margin-top: 10px;
            margin-bottom: 15px;
            padding-bottom: 10px;
        }
         /* --- FIM DOS NOVOS ESTILOS DAS ABAS --- */

        /* --- NOVOS ESTILOS DAS SUB-ABAS (Dentro de Estatísticas E Config) --- */
        .sub-tab-nav {
            display: flex;
            border-bottom: 2px solid #e0e0e0; /* Um pouco mais leve que a principal */
            margin-bottom: 15px;
        }
        
        .sub-tab-link {
            padding: 8px 12px;
            cursor: pointer;
            border: none;
            background-color: transparent;
            font-size: 0.95rem; /* Um pouco menor */
            font-weight: bold;
            color: #868e96;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px; 
            transition: all 0.2s;
            flex-grow: 1; 
            text-align: center;
        }
        
        .sub-tab-link:hover {
            color: #495057;
            background-color: #f8f9fa;
        }
        
        .sub-tab-link.active {
            color: #004a8d; 
            border-bottom: 3px solid #004a8d;
        }

        .sub-tab-content {
            display: none; /* Esconde por padrão */
        }
        
        .sub-tab-content.active {
            display: block; /* Mostra o ativo */
        }
        
        #ticket-info-content .stat-item {
            /* Estilo para os itens de info do ticket */
            padding: 8px 0;
        }
        
        #ticket-info-content .stat-item span:first-child {
            font-weight: bold;
            color: #004a8d;
            min-width: 150px; /* Alinhamento */
        }
        /* --- FIM DOS ESTILOS DAS SUB-ABAS --- */
        
        /* --- NOVOS Estilos para Formulário de Configuração de Guichês --- */
        .guiche-config-form {
            display: flex;
            align-items: center;
            gap: 8px;
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 6px;
        }
        
        .guiche-config-form label {
            margin-bottom: 0; /* Alinha com o input */
        }

        #guiche-naming-list .form-group {
            margin-bottom: 10px;
        }

        #guiche-naming-list .form-group label {
            font-weight: normal;
            margin-bottom: 5px;
            font-size: 0.95rem;
        }
        
        #guiche-naming-list .form-group input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 6px;
        }
        /* --- FIM: NOVOS Estilos --- */

        /* --- NOVOS ESTILOS DE SEÇÃO DO PAINEL (REORGANIZAÇÃO) --- */
        .secao-painel {
            margin-bottom: 25px; /* Espaço entre as seções */
        }
        
        .secao-painel:last-child {
            margin-bottom: 0;
        }

        /* Ajusta margens de elementos movidos para as novas seções */
        .secao-painel .controls {
            margin-bottom: 0;
        }
        
        .secao-painel.fila {
            margin-top: 0;
        }
        /* --- FIM: NOVOS ESTILOS DE SEÇÃO --- */

        /* --- NOVO: Estilo para a tabela de estatísticas --- */
        .stats-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            margin-top: 10px; /* Adicionado */
        }
        .stats-table th, .stats-table td {
            border: 1px solid #ddd;
            padding: 8px 10px;
            text-align: center;
            font-size: 0.95rem;
        }
        .stats-table th {
            background-color: #f8f9fa;
            color: #004a8d;
            font-weight: bold;
        }
        .stats-table td:first-child {
            text-align: left;
            font-weight: bold;
        }
        /* Cor de destaque para Prioridade */
        .stats-table tr[data-tipo="prioridade"] td:first-child { color: #c92a2a; }
        /* Cor de destaque para Contratual */
        .stats-table tr[data-tipo="contratual"] td:first-child { color: #7048e8; }
        /* Cor de destaque para Normal */
        .stats-table tr[data-tipo="normal"] td:first-child { color: #004a8d; }
        /* --- FIM: Estilo da tabela --- */


        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .controls {
                grid-template-columns: 1fr;
            }

            /* --- NOVO: Ajuste de Filtros para mobile --- */
            .filtro-fila-wrapper {
                flex-direction: column;
                align-items: stretch;
            }
            .filtro-botoes {
                justify-content: space-around;
            }
            .filtro-busca-wrapper {
                width: 100%;
            }
            #filtro-busca {
                width: 100%;
            }
            /* --- FIM: Ajuste mobile --- */
        }
    </style>
    <link rel="stylesheet" href="css/all.min.css">
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-mail-bulk"></i> Sistema de Senhas - Correios</h1>
            <p>Sistema de atendimento por prioridade legal</p>
            </header>
        
        <div class="dashboard">
            
            <div class="card">
                
                <div class="secao-painel">
                    <h3><i class="fas fa-desktop"></i> Painéis de Guichê</h3>
                    <div id="guiche-control-panels">
                        </div>
                </div>

                <div class="secao-painel fila"> <h3><i class="fas fa-user-headset"></i> Atendendo (Todos)</h3>
                    <div class="lista-senhas" id="lista-atendimentos-atuais">
                        </div>
                </div>
                
                <div class="secao-painel">
                    <h3><i class="fas fa-ticket-alt"></i> Emissão de Senhas</h3>
                    <div class="controls">
                        <button id="btn-prioridade" class="btn-prioridade">
                            <i class="fas fa-wheelchair"></i> Prioritária
                        </button>
                        <button id="btn-normal" class="btn-normal">
                            <i class="fas fa-user"></i> Normal
                        </button>
                        <button id="btn-contratual" class="btn-contratual">
                            <i class="fas fa-file-contract"></i> Contratual
                        </button>
                        
                        <button id="btn-reiniciar" class="btn-reiniciar">
                            <i class="fas fa-redo"></i> Reiniciar Sistema
                        </button>
                    </div>
                </div>
                
                <div class="secao-painel fila"> <h3><i class="fas fa-clock"></i> Fila de Espera</h3>

                    <div class="filtro-fila-wrapper">
                        <div class="filtro-botoes">
                            <button class="btn-filtro active" data-filtro="emissao" title="Ordenar por ordem de chegada">
                                <i class="fas fa-clock"></i> Emissão
                            </button>
                            <button class="btn-filtro" data-filtro="automatica" title="Ordenar pela lógica de proporção (P:C:N)">
                                <i class="fas fa-cogs"></i> Automática
                            </button>
                            <button class="btn-filtro" data-filtro="tipo" title="Agrupar por tipo (Prioridade > Contratual > Normal)">
                                <i class="fas fa-layer-group"></i> Tipo
                            </button>
                        </div>
                        <div class="filtro-busca-wrapper">
                            <i class="fas fa-search"></i>
                            <input type="text" id="filtro-busca" placeholder="Buscar na descrição...">
                        </div>
                    </div>
                    <div class="lista-senhas" id="lista-espera">
                        </div>
                </div>

            </div>
            <div class="card">
                
                <div class="tab-nav">
                    <button class="tab-link active" data-tab="tab-stats">
                        <i class="fas fa-chart-bar"></i> Estatísticas
                    </button>
                    <button class="tab-link" data-tab="tab-history">
                        <i class="fas fa-history"></i> Histórico
                    </button>
                    <button class="tab-link" data-tab="tab-config">
                        <i class="fas fa-cogs"></i> Configurações
                    </button>
                </div>

                <div class="tab-content-wrapper">

                    <div id="tab-stats" class="tab-content active">
                        
                        <div class="sub-tab-nav">
                            <button class="sub-tab-link active" data-sub-tab="sub-tab-geral">
                                <i class="fas fa-chart-bar"></i> Geral
                            </button>
                            <button class="sub-tab-link" data-sub-tab="sub-tab-ticket">
                                <i class="fas fa-ticket-alt"></i> Ticket
                            </button>
                        </div>

                        <div class="sub-tab-content-wrapper">
                            
                            <div id="sub-tab-geral" class="sub-tab-content active">
                                <h2><i class="fas fa-chart-pie"></i> Resumo do Dia</h2>
                                <div class="stats">
                                    <div class="stat-item">
                                        <span>Senhas emitidas hoje:</span>
                                        <span id="total-senhas">0</span>
                                    </div>
                                    <div class="stat-item">
                                        <span>Senhas atendidas:</span>
                                        <span id="senhas-atendidas">0</span>
                                    </div>
                                    <div class="stat-item">
                                        <span>Tempo médio de espera:</span>
                                        <span id="tempo-medio">0 min</span>
                                    </div>
                                    <div class="stat-item">
                                        <span>Próxima senha (Lógica):</span>
                                        <span id="proxima-senha">---</span>
                                    </div>
                                </div>
                                
                                <h2 style="margin-top: 20px;"><i class="fas fa-tasks"></i> Desempenho por Tipo</h2>
                                <table class="stats-table">
                                    <thead>
                                        <tr>
                                            <th>Tipo</th>
                                            <th>Emitidas</th>
                                            <th>Atendidas</th>
                                            <th>T.M. Espera</th>
                                            <th>T.M. Atend.</th>
                                            <th>Maior Espera</th>
                                            <th>Menor Espera</th>
                                        </tr>
                                    </thead>
                                    <tbody id="stats-por-tipo">
                                        </tbody>
                                </table>
                                
                                <h2 style="margin-top: 20px;"><i class="fas fa-user-headset"></i> Desempenho por Guichê</h2>
                                <div class="stats" id="stats-por-guiche">
                                    </div>
                                
                                <h2 style="margin-top: 20px;"><i class="fas fa-user-slash"></i> Abandono e Exclusões</h2>
                                <div class="stats">
                                    <div class="stat-item">
                                        <span>Senhas (Não Compareceu):</span>
                                        <span id="total-nao-compareceu">0</span>
                                    </div>
                                    <div class="stat-item">
                                        <span>Senhas (Excluídas da Fila):</span>
                                        <span id="total-excluidas">0</span>
                                    </div>
                                </div>
                            </div>
                            <div id="sub-tab-ticket" class="sub-tab-content">
                                <h2><i class="fas fa-info-circle"></i> Detalhes do Ticket</h2>
                                <div class="stats" id="ticket-info-content">
                                    <p style="padding: 10px 0; color: #868e96;">
                                        Clique no ícone <i class="fas fa-info-circle"></i> de uma senha na fila de espera para ver os detalhes.
                                    </p>
                                </div>
                            </div>
                        </div>

                    </div>
                    <div id="tab-history" class="tab-content">
                        <h2><i class="fas fa-history"></i> Histórico de Atendimentos</h2>
                        <div class="fila">
                            <div class="lista-senhas" id="historico-atendimentos" style="max-height: 300px; overflow-y: auto;">
                                </div>
                        </div>
                    </div>

                    <div id="tab-config" class="tab-content">
                        
                        <div class="sub-tab-nav">
                            <button class="sub-tab-link active" data-sub-tab="sub-tab-guiches">
                                <i class="fas fa-desktop"></i> Guichês
                            </button>
                            <button class="sub-tab-link" data-sub-tab="sub-tab-proporcao">
                                <i class="fas fa-balance-scale-right"></i> Proporção
                            </button>
                        </div>
                
                        <div class="sub-tab-content-wrapper">
                            
                            <div id="sub-tab-guiches" class="sub-tab-content active">
                                <h2><i class="fas fa-desktop"></i> Gerenciar Guichês</h2>
                                
                                <h3 style="margin-top: 15px;"><i class="fas fa-desktop-alt"></i> Exibição (Este Navegador)</h3>
                                <p style="margin-bottom: 15px; color: #555;">Selecione os guichês que deseja exibir no painel de controle desta aba. A seleção é salva automaticamente.</p>
                                
                                <div id="guiche-exibicao-list" style="margin-top: 20px; display: flex; flex-direction: column; gap: 10px;">
                                    </div>
                                
                                <hr style="margin: 25px 0; border: none; border-top: 1px solid #eee;">

                                <h3><i class="fas fa-users-cog"></i> Guichês (Global)</h3>
                                <p style="margin-bottom: 15px; color: #555;">Adicione, nomeie e ative/desative guichês para <strong>todo o sistema</strong>. Guichês inativos não são contados na estimativa de tempo. As alterações são salvas automaticamente.</p>
                                
                                <div id="guiche-global-list" style="margin-top: 20px; display: flex; flex-direction: column; gap: 10px;">
                                </div>
                                
                                <button id="btn-add-guiche-global" style="padding: 8px 12px; margin-top: 15px;">
                                    <i class="fas fa-plus"></i> Adicionar Guichê
                                </button>
                            </div>
                            <div id="sub-tab-proporcao" class="sub-tab-content">
                                <h2><i class="fas fa-balance-scale-right"></i> Configurações de Proporção</h2>
                                <div class="ratio-control">
                                    <label for="input-ratio"><i class="fas fa-balance-scale-right"></i> Proporção (P:N):</label>
                                    <input type="number" id="input-ratio" min="1" value="2">
                                    <span> : 1</span>
                                </div>
                
                                <div class="ratio-control">
                                    <label for="input-ratio-contratual"><i class="fas fa-file-contract"></i> Proporção (C:N):</label>
                                    <input type="number" id="input-ratio-contratual" min="1" value="1">
                                    <span> : 1</span>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="alert">
            <i class="fas fa-info-circle"></i> <strong>Prioridades legais:</strong> Idosos (60+), gestantes, lactantes, pessoas com crianças de colo e pessoas com deficiência têm direito a atendimento prioritário.
        </div>
    </div>
    
    <div id="modal-reiniciar" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Reiniciar Sistema</h3>
            </div>
            <p>Tem certeza que deseja reiniciar o sistema? Todos os dados serão perdidos.</p>
            <div class="controls-modal-reiniciar">
                <button id="btn-confirmar-reiniciar" class="btn-reiniciar-confirmar">Reiniciar</button>
                <button id="btn-cancelar-reiniciar" class="btn-cancelar">Cancelar</button>
            </div>
        </div>
    </div>

    <div id="modal-nova-senha" class="modal modal-clicavel-fechar">
        <div class="modal-content-nova-senha">
            <span>Nova Senha Emitida</span>
            <div id="senha-gerada-numero">---</div>
            
            <div class="form-group-modal-senha" id="form-group-nova-senha">
                <label for="textarea-nova-senha-descricao">Descrição (Opcional - Pressione Enter para salvar):</label>
                <textarea id="textarea-nova-senha-descricao" rows="3" placeholder="Ex: Alteração de CPF..."></textarea>
                <input type="hidden" id="hidden-nova-senha-numero">
            </div>
        </div>
    </div>

    <div id="modal-editar-descricao" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-editar-titulo">Editar Descrição</h3>
                <span class="close" id="btn-fechar-modal-editar">&times;</span>
            </div>
            <div class="form-group">
                <label for="textarea-editar-descricao">Descrição:</label>
                <textarea id="textarea-editar-descricao" rows="4"></textarea>
                <input type="hidden" id="hidden-editar-senha-numero">
            </div>
            <div class="controls-modal-editar">
                <button id="btn-salvar-descricao" class="btn-salvar-descricao"><i class="fas fa-save"></i> Salvar</button>
            </div>
        </div>
    </div>

    <div id="modal-confirmar-acao" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-confirmar-titulo">Confirmar Ação</h3>
            </div>
            <p id="modal-confirmar-texto" style="margin-top: 15px;"></p>
            <div class="controls-modal-reiniciar" style="margin-top: 25px;">
                <button id="btn-confirmar-acao-confirmar" class="btn-reiniciar-confirmar">Confirmar</button>
                <button id="btn-confirmar-acao-cancelar" class="btn-cancelar">Cancelar</button>
            </div>
        </div>
    </div>
    <script src="/socket.io/socket.io.js"></script>
    
    <script>
        $(document).ready(function() {
            const socket = io();

            // --- Variáveis de estado locais ---
            let estadoLocal = {}; // Armazena o estado completo do servidor
            let estatisticasLocais = {}; // *** NOVO: Armazena as estatísticas ***
            
            let descricaoAtiva = false; // Controla o estado do textarea
            let acaoConfirmadaCallback = null; // Para o modal de confirmação
            
            // --- ATUALIZADO: Separação de configs de guichê ---
            let guichesGlobais = []; // Config GLOBAL (do servidor)
            
            // --- NOVO: Variáveis de estado dos filtros ---
            let filtroAtivo = 'emissao'; // 'emissao', 'automatica', 'tipo'
            let termoBusca = '';
            const tipoValor = { 'prioridade': 1, 'contratual': 2, 'normal': 3 }; // Helper para ordenação

            // --- NOVO: Variável de estado para a aba de detalhes ---
            let ticketInfoSendoExibido = null;
            
            // --- Elementos da interface ---
            const $listaEspera = $('#lista-espera');
            const $listaAtendimentosAtuais = $('#lista-atendimentos-atuais');
            const $historicoAtendimentos = $('#historico-atendimentos');
            
            // --- Elementos de Estatísticas ---
            const $totalSenhas = $('#total-senhas');
            const $senhasAtendidas = $('#senhas-atendidas');
            const $tempoMedio = $('#tempo-medio');
            const $proximaSenha = $('#proxima-senha');
            const $statsPorTipo = $('#stats-por-tipo');
            const $statsPorGuiche = $('#stats-por-guiche');
            const $totalNaoCompareceu = $('#total-nao-compareceu');
            const $totalExcluidas = $('#total-excluidas');
            // --- NOVO: Elemento da aba de stats (para delegação) ---
            const $tabStats = $('#tab-stats');

            // Botões
            const $btnPrioridade = $('#btn-prioridade');
            const $btnNormal = $('#btn-normal');
            const $btnContratual = $('#btn-contratual');
            const $btnReiniciar = $('#btn-reiniciar');
            
            const $inputRatio = $('#input-ratio');
            const $inputRatioContratual = $('#input-ratio-contratual');

            // Modais
            const $modalReiniciar = $('#modal-reiniciar');
            const $modalNovaSenha = $('#modal-nova-senha');
            const $modalEditarDescricao = $('#modal-editar-descricao'); 
            const $modalConfirmarAcao = $('#modal-confirmar-acao'); 
            const $modalConfirmarTitulo = $('#modal-confirmar-titulo'); 
            const $modalConfirmarTexto = $('#modal-confirmar-texto'); 

            // --- ATUALIZADO: Gerenciamento de Configuração de Guichês (Exibição Local) ---
            const $guicheControlPanels = $('#guiche-control-panels');
            
            // --- NOVO: Seletores de Configuração Global de Guichês ---
            const $guicheGlobalList = $('#guiche-global-list');
            const $btnAddGuicheGlobal = $('#btn-add-guiche-global');
            const $guicheExibicaoList = $('#guiche-exibicao-list');
            // --- REMOVIDO: $btnSalvarExibicaoGuiches
            
            
            // --- NOVO: Lógica de Exibição de Guichês ---
            function renderizarGuichesExibicao() {
                $guicheExibicaoList.empty();

                // *** ALTERADO: Usa sessionStorage (por aba) ao invés de localStorage (global) ***
                const exibicaoSalva = sessionStorage.getItem('sgfGuichesExibicao');
                const guichesExibicao = exibicaoSalva ? JSON.parse(exibicaoSalva) : [];

                if (guichesGlobais.length === 0) {
                    $guicheExibicaoList.html('<p style="color: #868e96;">Nenhum guichê global cadastrado. Adicione guichês na seção "Guichês (Global)".</p>');
                    return;
                }
                
                guichesGlobais.forEach(guiche => {
                    const estaSelecionado = guichesExibicao.includes(guiche.nome);
                    $guicheExibicaoList.append(`
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" id="exibicao-${guiche.nome}" ${estaSelecionado ? 'checked' : ''} data-guiche-nome="${guiche.nome}" style="transform: scale(1.2);">
                            <label for="exibicao-${guiche.nome}" style="margin-bottom: 0; font-weight: normal;">${guiche.nome} ${guiche.ativo ? '' : '(Inativo)'}</label>
                        </div>
                    `);
                });
            }

            function salvarExibicaoGuiches() {
                const guichesSelecionados = [];
                $('#guiche-exibicao-list input[type="checkbox"]:checked').each(function() {
                    guichesSelecionados.push($(this).data('guiche-nome'));
                });
                
                // *** ALTERADO: Usa sessionStorage (por aba) ao invés de localStorage (global) ***
                sessionStorage.setItem('sgfGuichesExibicao', JSON.stringify(guichesSelecionados));
                renderizarPaineisDeGuiche();
                
                // --- REMOVIDO: Feedback visual do botão ---
            }

            // *** NOVO: Event listener para o checkbox de exibição (substitui o botão) ***
            $guicheExibicaoList.on('change', 'input[type="checkbox"]', salvarExibicaoGuiches);
            
            // --- NOVO: Lógica de Guichês GLOBAIS (Servidor) ---
            
            function renderizarGuichesGlobais() {
                $guicheGlobalList.empty();
                if (guichesGlobais.length === 0) {
                    $guicheGlobalList.html('<p style="color: #868e96;">Nenhum guichê global cadastrado. Clique em "Adicionar Guichê".</p>');
                }
                
                guichesGlobais.forEach((guiche, index) => {
                    const checked = guiche.ativo ? 'checked' : '';
                    // Escapa o nome para o value do input
                    const nomeEscapado = $('<div />').text(guiche.nome).html();
                    
                    $guicheGlobalList.append(`
                        <div style="display: flex; gap: 10px; align-items: center; background: #f8f9fa; padding: 10px; border-radius: 6px;">
                            <input type="text" class="guiche-global-nome" data-index="${index}" value="${nomeEscapado}" placeholder="Nome do Guichê" style="flex-grow: 1; padding: 8px; border: 1px solid #ddd; border-radius: 6px;">
                            <input type="checkbox" class="guiche-global-ativo" data-index="${index}" id="guiche-ativo-${index}" ${checked} style="transform: scale(1.2); cursor: pointer;">
                            <label for="guiche-ativo-${index}" style="margin-bottom: 0; font-weight: normal; cursor: pointer;">Ativo</label>
                            <button class="btn-acao-senha btn-acao-excluir btn-delete-guiche-global" data-index="${index}" title="Excluir Guichê">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                    `);
                });
                
                // Re-renderizar a lista de exibição sempre que os guichês globais mudarem
                renderizarGuichesExibicao();
            }
            
            $btnAddGuicheGlobal.on('click', function() {
                const novoNome = `Guichê ${String(guichesGlobais.length + 1).padStart(2, '0')}`;
                guichesGlobais.push({ nome: novoNome, ativo: true });
                salvarGuichesGlobais(); // Salva e renderiza automaticamente
            });

            $guicheGlobalList.on('click', '.btn-delete-guiche-global', function() {
                const index = parseInt($(this).data('index'), 10);
                if (!isNaN(index) && guichesGlobais[index]) {
                    const nome = guichesGlobais[index].nome;
                    mostrarModalConfirmacao(
                        'Excluir Guichê Global',
                        `Tem certeza que deseja excluir o guichê <strong>${nome}</strong> do sistema?<br><br>Esta ação não pode ser desfeita.`,
                        function() {
                            guichesGlobais.splice(index, 1);
                            // Salva e renderiza automaticamente
                            salvarGuichesGlobais();
                        }
                    );
                }
            });

            // Event listeners para salvar automaticamente em qualquer alteração
            $guicheGlobalList.on('input', '.guiche-global-nome', function() {
                salvarGuichesGlobais();
            });

            $guicheGlobalList.on('change', '.guiche-global-ativo', function() {
                salvarGuichesGlobais();
            });

            function salvarGuichesGlobais() {
                const novosGuiches = [];
                $('.guiche-global-nome').each(function() {
                    const index = parseInt($(this).data('index'), 10);
                    const nome = $(this).val().trim();
                    const ativo = $(`#guiche-ativo-${index}`).is(':checked');

                    if (nome && !isNaN(index)) {
                        // Usa o índice para manter a ordem
                        novosGuiches[index] = { nome: nome, ativo: ativo };
                    }
                });

                // Filtra 'empty slots' se houver
                const guichesFinais = novosGuiches.filter(g => g !== undefined);

                // *** NOVO: Atualiza os guichês selecionados quando um nome é alterado ***
                const exibicaoSalva = sessionStorage.getItem('sgfGuichesExibicao');
                const guichesExibicao = exibicaoSalva ? JSON.parse(exibicaoSalva) : [];
                const guichesExibicaoAtualizados = [];

                // Para cada guichê selecionado, verifica se o nome mudou
                guichesExibicao.forEach(nomeAntigo => {
                    // Procura o guichê antigo pelo índice
                    const indexAntigo = guichesGlobais.findIndex(g => g.nome === nomeAntigo);

                    if (indexAntigo !== -1 && guichesFinais[indexAntigo]) {
                        // Usa o novo nome do guichê no mesmo índice
                        guichesExibicaoAtualizados.push(guichesFinais[indexAntigo].nome);
                    } else {
                        // Se não encontrou, mantém o nome antigo (caso o guichê não tenha mudado)
                        guichesExibicaoAtualizados.push(nomeAntigo);
                    }
                });

                // Salva a lista atualizada de guichês selecionados
                sessionStorage.setItem('sgfGuichesExibicao', JSON.stringify(guichesExibicaoAtualizados));

                guichesGlobais = guichesFinais;
                socket.emit('atualizarGuichesGlobais', guichesFinais);

                // Atualiza a interface
                renderizarGuichesGlobais();
                renderizarPaineisDeGuiche();

                // --- REMOVIDO: Feedback visual do botão (Req 2) ---
            }
            

            // --- NOVO: Lógica das Sub-Abas de Configuração ---
            $('#tab-config').on('click', '.sub-tab-link', function(e) {
                e.preventDefault();
                const $this = $(this);
                const subTabId = $this.data('sub-tab'); 

                $('#tab-config .sub-tab-link').removeClass('active');
                $('#tab-config .sub-tab-content').removeClass('active');

                $this.addClass('active');
                $('#' + subTabId).addClass('active');
            });


            // --- NOVO: Renderiza os painéis de controle dos guichês ---
            function renderizarPaineisDeGuiche() {
                $guicheControlPanels.empty();
                
                // *** ALTERADO: Usa sessionStorage (por aba) ao invés de localStorage (global) ***
                const exibicaoSalva = sessionStorage.getItem('sgfGuichesExibicao');
                const guichesParaExibir = exibicaoSalva ? JSON.parse(exibicaoSalva) : [];
                
                // *** ATUALIZADO: Usa estadoLocal para obter atendimentos ***
                const atendimentos = (estadoLocal && estadoLocal.atendimentosAtuais) ? estadoLocal.atendimentosAtuais : {};
                
                if (guichesParaExibir.length === 0) {
                    $guicheControlPanels.html('<div class="alert">Nenhum guichê selecionado para exibição. Vá para a aba <i class="fas fa-cogs"></i> Configurações > Guichês.</div>');
                    return;
                }

                guichesParaExibir.forEach(nomeGuiche => {
                    const atendimento = atendimentos[nomeGuiche];
                    
                    const isOcupado = !!atendimento;
                    const numeroSenha = isOcupado ? atendimento.numero : '---';
                    let classeTipo = '';
                    
                    if(atendimento) {
                        if (atendimento.tipo === 'prioridade') classeTipo = 'prioridade';
                        else if (atendimento.tipo === 'contratual') classeTipo = 'contratual';
                        else classeTipo = 'normal';
                    }

                    const numeroHtml = isOcupado 
                        ? `<span class="senha-numero">${numeroSenha}</span>`
                        : `<span class="senha-numero vazio">---</span>`;
                    
                    $guicheControlPanels.append(`
                        <div class="guiche-painel">
                            <div class="senha-atual-guiche ${classeTipo}" data-guiche-id="${nomeGuiche}">
                                <span class="guiche-painel-nome">${nomeGuiche}</span>
                                ${numeroHtml}
                            </div>
                        </div>
                    `);
                });
            }


            // --- Event Listeners (Botões) ---

            $btnPrioridade.on('click', function() {
                socket.emit('emitirSenha', { tipo: 'prioridade', subtipo: '' });
                $(this).blur(); 
            });
            
            $btnNormal.on('click', function() {
                socket.emit('emitirSenha', { tipo: 'normal' });
                $(this).blur(); 
            });

            $btnContratual.on('click', function() {
                socket.emit('emitirSenha', { tipo: 'contratual' });
                $(this).blur(); 
            });
            
            // --- ATUALIZADO: Click handler para painéis de guichê dinâmicos ---
            $guicheControlPanels.on('click', '.senha-atual-guiche', function() {
                const $this = $(this);
                const guicheId = $this.data('guiche-id'); // O nome real, e.g., "Guichê 01"
                
                // --- MODIFICADO: Verifica a classe 'vazio' no filho ---
                const estaOcupado = !$this.find('.senha-numero').hasClass('vazio');

                if (!guicheId) return;

                if (estaOcupado) {
                    // Guichê está ocupado, finalizar
                    console.log(`Finalizando atendimento no ${guicheId}`);
                    socket.emit('finalizarAtendimento', { guicheId: guicheId });
                } else {
                    // Guichê está livre, chamar próxima
                    console.log(`Solicitando próxima senha para ${guicheId}`);
                    socket.emit('chamarSenha', { guicheId: guicheId });
                }
            });
            
            $btnReiniciar.on('click', function() {
                $modalReiniciar.css('display', 'flex');
            });
            
            $('#btn-confirmar-reiniciar').on('click', function() {
                socket.emit('reiniciarSistema');
                $modalReiniciar.css('display', 'none');
            });
            
            $('#btn-cancelar-reiniciar').on('click', function() {
                $modalReiniciar.css('display', 'none');
            });
            
            $inputRatio.on('change', function() {
                const novaProporcao = parseInt($(this).val(), 10);
                if (!isNaN(novaProporcao) && novaProporcao >= 1) {
                    socket.emit('atualizarProporcao', novaProporcao);
                } else {
                    $(this).val(1);
                    socket.emit('atualizarProporcao', 1);
                }
            });
            
            $inputRatioContratual.on('change', function() {
                const novaProporcao = parseInt($(this).val(), 10);
                if (!isNaN(novaProporcao) && novaProporcao >= 1) {
                    socket.emit('atualizarProporcaoContratual', novaProporcao);
                } else {
                    $(this).val(1);
                    socket.emit('atualizarProporcaoContratual', 1);
                }
            });
            
            // --- NOVO: Event Listeners dos Filtros ---
            $('.filtro-botoes').on('click', '.btn-filtro', function() {
                const $this = $(this);
                filtroAtivo = $this.data('filtro');
                
                // Atualiza o estado visual dos botões
                $('.btn-filtro').removeClass('active');
                $this.addClass('active');
                
                // Re-renderiza a lista com o novo filtro
                renderizarFilaDeEspera(); 
            });

            $('#filtro-busca').on('keyup', function() {
                termoBusca = $(this).val().trim().toLowerCase();
                // Re-renderiza a lista com o termo de busca
                renderizarFilaDeEspera();
            });
            // --- FIM: Event Listeners dos Filtros ---


            // --- Lógica do Modal de Nova Senha (Sem alteração) ---
            
            $('.modal-content-nova-senha').on('click', function(e) {
                if (!descricaoAtiva) {
                    return;
                }
                e.stopPropagation();
            });

            function fecharModalNovaSenha() {
                const numeroSenha = $('#hidden-nova-senha-numero').val();
                const descricao = $('#textarea-nova-senha-descricao').val().trim();
                
                if (numeroSenha && descricao) {
                    console.log(`Salvando descrição para ${numeroSenha}`);
                    socket.emit('atualizarDescricao', { numeroSenha: numeroSenha, descricao: descricao });
                }
                
                $modalNovaSenha.hide();
                $('body').css('overflow', 'auto');
                
                $('#hidden-nova-senha-numero').val('');
                $('#textarea-nova-senha-descricao').val('');
                $('#form-group-nova-senha').hide(); 
                descricaoAtiva = false; 
            }
            
            $modalNovaSenha.on('click', fecharModalNovaSenha);
            
            $(document).on('keydown', function(e) {
                if (!$modalNovaSenha.is(':visible')) {
                    return;
                }
                const isEnter = (e.which === 13 || e.key === "Enter");
                if (isEnter) {
                    e.preventDefault(); 
                    if (!descricaoAtiva) {
                        descricaoAtiva = true;
                        $('#form-group-nova-senha').slideDown(200); 
                        $('#textarea-nova-senha-descricao').focus(); 
                    } else {
                        fecharModalNovaSenha();
                    }
                } 
                else {
                    if (!descricaoAtiva) {
                        fecharModalNovaSenha();
                    }
                }
            });

            // --- FIM: Lógica do Modal de Nova Senha ---

            // --- Lógica das Abas (Principal) ---
            $('.tab-nav').on('click', '.tab-link', function(e) {
                e.preventDefault();
                const $this = $(this);
                const tabId = $this.data('tab'); 

                $('.tab-link').removeClass('active');
                $('.tab-content').removeClass('active');

                $this.addClass('active');
                $('#' + tabId).addClass('active');
            });

            // --- Lógica das Sub-Abas (Estatísticas) ---
            $('#tab-stats').on('click', '.sub-tab-link', function(e) {
                e.preventDefault();
                const $this = $(this);
                const subTabId = $this.data('sub-tab'); 

                $('#tab-stats .sub-tab-link').removeClass('active');
                $('#tab-stats .sub-tab-content').removeClass('active');

                $this.addClass('active');
                $('#' + subTabId).addClass('active');

                // *** NOVO: Limpa o ticket sendo exibido se sair da aba ***
                if (subTabId !== 'sub-tab-ticket') {
                    ticketInfoSendoExibido = null;
                    // Reseta o painel de detalhes
                    $('#ticket-info-content').html(`
                        <p style="padding: 10px 0; color: #868e96;">
                            Clique no ícone <i class="fas fa-info-circle"></i> de uma senha na fila de espera para ver os detalhes.
                        </p>
                    `);
                }
            });

            // --- Lógica do Modal de Confirmação ---
            function mostrarModalConfirmacao(titulo, texto, callback) {
                $modalConfirmarTitulo.text(titulo);
                $modalConfirmarTexto.html(texto); // Usar .html() para permitir <br> e <strong>
                acaoConfirmadaCallback = callback;
                $modalConfirmarAcao.css('display', 'flex');
            }

            $('#btn-confirmar-acao-cancelar').on('click', function() {
                $modalConfirmarAcao.css('display', 'none');
                acaoConfirmadaCallback = null;
            });
            
            $('#btn-confirmar-acao-confirmar').on('click', function() {
                if (typeof acaoConfirmadaCallback === 'function') {
                    acaoConfirmadaCallback();
                }
                $modalConfirmarAcao.css('display', 'none');
                acaoConfirmadaCallback = null;
            });


            // --- Event Listeners para botões de Ação na Fila ---
            // *** ATUALIZADO (Req 4): Seletores agora incluem #historico-atendimentos ***

            // --- ATUALIZADO: Lógica de chamada manual ---
            $('#lista-espera, #historico-atendimentos').on('click', '.btn-acao-chamar', function() {
                // Usa a config de EXIBIÇÃO do sessionStorage
                const exibicaoSalva = sessionStorage.getItem('sgfGuichesExibicao');
                const meusGuiches = exibicaoSalva ? JSON.parse(exibicaoSalva) : [];
                
                if (meusGuiches.length === 0) {
                     mostrarModalConfirmacao('Erro', 'Nenhum guichê está configurado para exibição nesta aba. Vá para Configurações > Guichês.', () => {});
                    return;
                }
                
                // *** ATUALIZADO: Usa estadoLocal ***
                const atendimentos = (estadoLocal && estadoLocal.atendimentosAtuais) ? estadoLocal.atendimentosAtuais : {};
                const guicheLivre = meusGuiches.find(nome => !atendimentos[nome]);

                if (!guicheLivre) {
                    mostrarModalConfirmacao('Atenção', 'Todos os seus guichês de exibição estão ocupados. Finalize um atendimento antes de chamar uma senha manualmente.', () => {});
                    return;
                }
                
                const numeroSenha = $(this).data('senha-numero');
                if (!numeroSenha) return;
                
                console.log(`Solicitando chamada manual de ${numeroSenha} para ${guicheLivre}`);
                socket.emit('chamarSenhaEspecifica', { 
                    guicheId: guicheLivre, 
                    numeroSenha: numeroSenha 
                });
            });

            $('#lista-espera, #historico-atendimentos').on('click', '.btn-acao-excluir', function() {
                const numeroSenha = $(this).data('senha-numero');
                if (!numeroSenha) return;
                mostrarModalConfirmacao(
                    'Excluir Senha', 
                    `Tem certeza que deseja excluir a senha <strong>${numeroSenha}</strong> da fila?`, 
                    function() {
                        socket.emit('excluirSenha', { 
                            numeroSenha: numeroSenha 
                        });
                    }
                );
            });

            // --- ATUALIZADO (Req 4): Handler do .btn-acao-info (Aba de Detalhes do Ticket) ---
            $('#lista-espera, #historico-atendimentos').on('click', '.btn-acao-info', function() {
                const numeroSenha = $(this).data('senha-numero');
                if (!numeroSenha) return;

                // Abre as abas corretas
                $('.tab-link[data-tab="tab-stats"]').trigger('click');
                $('.sub-tab-link[data-sub-tab="sub-tab-ticket"]').trigger('click');
                
                // *** NOVO: Define e renderiza ***
                ticketInfoSendoExibido = numeroSenha;
                renderizarDetalhesDoTicket(numeroSenha);
            });

            // --- NOVO: Handler para botão devolver ---
            $listaAtendimentosAtuais.on('click', '.btn-acao-devolver', function() {
                const numeroSenha = $(this).data('senha-numero');
                if (!numeroSenha) return;
                
                mostrarModalConfirmacao(
                    'Devolver à Fila', 
                    `Tem certeza que deseja devolver a senha <strong>${numeroSenha}</strong> para a fila de espera?`, 
                    function() {
                        socket.emit('devolverSenha', { 
                            numeroSenha: numeroSenha 
                        });
                    }
                );
            });

            // --- *** NOVO: Função para renderizar/atualizar detalhes do ticket *** ---
            function renderizarDetalhesDoTicket(numeroSenha) {
                // Usa os dados locais mais recentes
                const senhas = (estadoLocal && estadoLocal.senhas) ? estadoLocal.senhas : [];
                // *** ATUALIZADO (Req 3): Busca em todas as senhas, não apenas na fila ***
                const senha = senhas.find(s => s.numero === numeroSenha);
                const stats = estatisticasLocais || {}; // Usa as estatísticas mais recentes
                
                const $content = $('#ticket-info-content');

                if (senha) {
                    $content.empty();
                    
                    // --- INÍCIO: Lógica "Pessoas na Frente" (Copiada de renderizarFilaDeEspera) ---
                    let posicao = -1;
                    let pessoasNaFrente = 'N/A';
                    
                    if (senha.status === 'espera') {
                        const senhasEspera = (estadoLocal.senhas || []).filter(s => s.status === 'espera');
                        
                        const filaSimulada = [];
                        let simFilaEspera = [...senhasEspera].sort((a, b) => a.timestamp - b.timestamp);
                        let simContadorP = estadoLocal.contadorPrioridadeDesdeUltimaNormal || 0;
                        let simContadorC = estadoLocal.contadorContratualDesdeUltimaNormal || 0;
                        const proporcaoP = estadoLocal.proporcaoPrioridade || 2;
                        const proporcaoC = estadoLocal.proporcaoContratual || 1;

                        while (simFilaEspera.length > 0) {
                            const prioritariaMaisAntiga = simFilaEspera.find(s => s.tipo === 'prioridade');
                            const contratualMaisAntiga = simFilaEspera.find(s => s.tipo === 'contratual');
                            const normalMaisAntiga = simFilaEspera.find(s => s.tipo === 'normal');
                            let proximaSimulada = null;

                            if (prioritariaMaisAntiga && simContadorP < proporcaoP) {
                                proximaSimulada = prioritariaMaisAntiga;
                                simContadorP++; 
                            }
                            else if (contratualMaisAntiga && simContadorC < proporcaoC) {
                                proximaSimulada = contratualMaisAntiga;
                                simContadorC++;
                            }
                            else if (normalMaisAntiga) {
                                proximaSimulada = normalMaisAntiga;
                                simContadorP = 0; 
                                simContadorC = 0;
                            }
                            else if (prioritariaMaisAntiga) {
                                proximaSimulada = prioritariaMaisAntiga;
                                simContadorP++;
                            }
                            else if (contratualMaisAntiga) {
                                proximaSimulada = contratualMaisAntiga;
                                simContadorC++; 
                            }
                            
                            if (proximaSimulada) {
                                filaSimulada.push(proximaSimulada);
                                simFilaEspera = simFilaEspera.filter(s => s.numero !== proximaSimulada.numero);
                            } else {
                                break; 
                            }
                        }
                        
                        posicao = filaSimulada.findIndex(s => s.numero === numeroSenha);
                        pessoasNaFrente = (posicao !== -1) ? `${posicao} pessoas na frente` : 'N/A';
                    }
                    // --- FIM: Lógica "Pessoas na Frente" ---

                    // --- INÍCIO: Lógica de Estimativa de Tempo ---
                    let estimativaMs = 0;
                    // Usa o TMA geral como padrão, ou 5 min (300.000 ms) se não houver dados
                    let tmaDefault = stats.tempoMedioAtendimentoGeralMs || 300000; 
                    if (tmaDefault === 0) tmaDefault = 300000; // Garante que não seja 0

                    const tmaPorTipo = {
                        'prioridade': (stats.detalhesPorTipo && stats.detalhesPorTipo.prioridade.tempoMedioAtendimentoMs) ? stats.detalhesPorTipo.prioridade.tempoMedioAtendimentoMs : tmaDefault,
                        'contratual': (stats.detalhesPorTipo && stats.detalhesPorTipo.contratual.tempoMedioAtendimentoMs) ? stats.detalhesPorTipo.contratual.tempoMedioAtendimentoMs : tmaDefault,
                        'normal': (stats.detalhesPorTipo && stats.detalhesPorTipo.normal.tempoMedioAtendimentoMs) ? stats.detalhesPorTipo.normal.tempoMedioAtendimentoMs : tmaDefault
                    };
                    
                    // Garante que nenhum TMA seja 0, pois quebra a estimativa
                    if (tmaPorTipo.prioridade === 0) tmaPorTipo.prioridade = tmaDefault;
                    if (tmaPorTipo.contratual === 0) tmaPorTipo.contratual = tmaDefault;
                    if (tmaPorTipo.normal === 0) tmaPorTipo.normal = tmaDefault;
                    
                    // --- ATUALIZADO: Usa a contagem de guichês ativos vinda do servidor ---
                    const guichesAtivos = stats.guichesAtivos || 1; // Vem de stats, calculado no server

                    // Itera na fila simulada (pessoas na frente)
                    if (posicao > 0) { // 'posicao' é o índice (0 é o próximo), então > 0 significa que há alguém na frente
                        for (let i = 0; i < posicao; i++) {
                            const pessoaNaFrente = filaSimulada[i];
                            estimativaMs += tmaPorTipo[pessoaNaFrente.tipo];
                        }
                    }
                    
                    // Divide pelo número de guichês
                    const estimativaFinalMs = (posicao >= 0) ? (estimativaMs / guichesAtivos) : 0;
                    
                    // NOVO: Cálculo de ETA
                    const agoraMs = new Date().getTime();
                    const etaMs = (estimativaFinalMs > 0) ? (agoraMs + estimativaFinalMs) : agoraMs;
                    // Formata o horário (ex: 10:30)
                    const etaFormatada = (estimativaFinalMs > 0 && isFinite(etaMs)) ? new Date(etaMs).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '---';
                    // Formata a duração (ex: 15 min)
                    const estimativaFormatada = formatarTempo(estimativaFinalMs);
                    
                    // --- FIM: Lógica de Estimativa ---

                    const tempoEsperaAtual = (senha.status === 'espera') ? calcularTempoEspera(senha.timestamp) : (senha.tempoEspera > 0 ? formatarTempo(senha.tempoEspera) : '0 min');
                    const tipo = senha.tipo.charAt(0).toUpperCase() + senha.tipo.slice(1);
                    const descricao = (senha.descricao || 'N/A').replace(/\n/g, '<br>');

                    // Timestamps Formatados (agora são re-calculados sempre)
                    const tsEmissao = new Date(senha.timestamp).toLocaleTimeString();
                    const tsChamada = senha.chamadaTimestamp ? new Date(senha.chamadaTimestamp).toLocaleTimeString() : '---';
                    const tsFinalizado = senha.finalizadoTimestamp ? new Date(senha.finalizadoTimestamp).toLocaleTimeString() : '---';
                    
                    // --- ATUALIZADO (Req 3): Botões condicionais ---
                    let botoesHTML = `
                        <button class="btn-acao-senha btn-acao-editar" data-senha-numero="${senha.numero}" title="Editar Descrição" style="padding: 5px 10px; font-size: 0.9rem;">
                            <i class="fas fa-edit"></i> Editar
                        </button>
                    `;
                    
                    if (senha.status === 'chamada') {
                        botoesHTML += `
                            <button class="btn-acao-senha btn-acao-devolver" data-senha-numero="${senha.numero}" title="Devolver à Fila" style="padding: 5px 10px; font-size: 0.9rem;">
                                <i class="fas fa-undo"></i> Devolver
                            </button>
                            <button class="btn-acao-senha btn-acao-excluir btn-excluir-atendimento" data-senha-numero="${senha.numero}" title="Marcar como Não-Compareceu" style="padding: 5px 10px; font-size: 0.9rem;">
                                <i class="fas fa-user-slash"></i> Ausente
                            </button>
                        `;
                    } else if (senha.status === 'espera') {
                         botoesHTML += `
                            <button class="btn-acao-senha btn-acao-chamar" data-senha-numero="${senha.numero}" title="Chamar esta senha" style="padding: 5px 10px; font-size: 0.9rem;">
                                <i class="fas fa-bullhorn"></i> Chamar
                            </button>
                            <button class="btn-acao-senha btn-acao-excluir btn-excluir-atendimento" data-senha-numero="${senha.numero}" title="Marcar como Não-Compareceu" style="padding: 5px 10px; font-size: 0.9rem;">
                                <i class="fas fa-user-slash"></i> Ausente
                            </button>
                            <button class="btn-acao-senha btn-acao-excluir" data-senha-numero="${senha.numero}" title="Excluir esta senha" style="padding: 5px 10px; font-size: 0.9rem;">
                                <i class="fas fa-trash-alt"></i> Excluir
                            </button>
                        `;
                    }
                    // --- FIM DA ATUALIZAÇÃO (Req 3) ---

                    const statusFormatado = {
                        'espera': 'Na Fila',
                        'chamada': 'Em Atendimento',
                        'atendida': 'Atendida',
                        'nao_compareceu': 'Não Compareceu',
                        'excluida': 'Excluída'
                    };

                    $content.append(`
                        <div class="stat-item">
                            <span>Número:</span>
                            <strong>${senha.numero}</strong>
                        </div>
                        <div class="stat-item">
                            <span>Tipo:</span>
                            <span>${tipo}</span>
                        </div>
                        <div class="stat-item">
                            <span>Status:</span>
                            <span>${statusFormatado[senha.status] || senha.status}</span>
                        </div>
                        <div class="stat-item">
                            <span>Posição (Automática):</span>
                            <span><strong>${pessoasNaFrente}</strong></span>
                        </div>
                        <div class="stat-item">
                            <span>Tempo de Espera:</span>
                            <span>${senha.status === 'espera' ? `~ ${tempoEsperaAtual} min` : tempoEsperaAtual}</span>
                        </div>
                        <div class="stat-item">
                            <span>Estimativa de Atend.:</span>
                            <span title="Estimativa baseada no TMA de quem está na frente e nº de guichês ativos."><strong>${senha.status === 'espera' ? `~ ${estimativaFormatada}` : '---'}</strong></span>
                        </div>
                        
                        <div class="stat-item">
                            <span>Horário Estimado:</span>
                            <span title="Horário estimado para o início do atendimento."><strong>${senha.status === 'espera' ? `~ ${etaFormatada}` : '---'}</strong></span>
                        </div>
                        <div class="stat-item">
                            <span>Emitida em:</span>
                            <span>${tsEmissao}</span>
                        </div>
                         <div class="stat-item">
                            <span>Chamada em:</span>
                            <span>${tsChamada}</span>
                        </div>
                         <div class="stat-item">
                            <span>Finalizada em:</span>
                            <span>${tsFinalizado}</span>
                        </div>
                        <div class="stat-item" style="flex-direction: column; align-items: flex-start;">
                            <span>Descrição:</span>
                            <span style="padding-top: 5px; color: #333; font-style: italic;">${descricao}</span>
                        </div>

                        <div class="botoes-wrapper" style="margin-top: 20px; justify-content: center; display: flex; gap: 10px;">
                            ${botoesHTML}
                        </div>
                        `);
                } else {
                    // Senha não existe mais (foi atendida/excluída)
                    ticketInfoSendoExibido = null;
                    $content.html(`
                        <p style="padding: 10px 0; color: #868e96;">
                            A senha ${numeroSenha} não está mais na fila de espera ou já foi atendida.
                        </p>
                    `);
                }
            }
            // --- *** FIM: Função de Detalhes do Ticket *** ---

            // --- ATUALIZADO (Req 4): Seletores agora incluem #historico-atendimentos ---
            $('#lista-espera, #historico-atendimentos').on('click', '.btn-acao-editar', function() {
                const numeroSenha = $(this).data('senha-numero');
                // *** ATUALIZADO: Usa estadoLocal ***
                const senhas = (estadoLocal && estadoLocal.senhas) ? estadoLocal.senhas : [];
                const senha = senhas.find(s => s.numero === numeroSenha);
                if (senha) {
                    $('#modal-editar-titulo').text(`Editar Descrição (${senha.numero})`);
                    $('#hidden-editar-senha-numero').val(senha.numero);
                    $('#textarea-editar-descricao').val(senha.descricao || '');
                    $modalEditarDescricao.css('display', 'flex');
                }
            });
            
            // --- NOVOS: Handlers para os botões na aba #tab-stats ---
            
            // NOVO: Handler para o botão "Ausente" na aba de Ticket
            $tabStats.on('click', '.btn-excluir-atendimento', function() {
                const numeroSenha = $(this).data('senha-numero');
                if (!numeroSenha) return;
                // Verifica se a senha está em espera ou chamada
                const senha = estadoLocal.senhas.find(s => s.numero === numeroSenha);
                const texto = `Tem certeza que deseja marcar a senha <strong>${numeroSenha}</strong> como NÃO-COMPARECEU?<br><br>Esta ação irá removê-la da fila/atendimento.`;
                
                if (senha && (senha.status === 'espera' || senha.status === 'chamada')) {
                    mostrarModalConfirmacao(
                        'Confirmar Não-Comparecimento', 
                        texto,
                        function() {
                            socket.emit('excluirAtendimento', { 
                                numeroSenha: numeroSenha 
                            });
                        }
                    );
                }
            });
            
            $tabStats.on('click', '.btn-acao-chamar', function() {
                // Lógica copiada do handler de $listaEspera
                // Usa a config de EXIBIÇÃO do sessionStorage
                const exibicaoSalva = sessionStorage.getItem('sgfGuichesExibicao');
                const meusGuiches = exibicaoSalva ? JSON.parse(exibicaoSalva) : [];
                
                if (meusGuiches.length === 0) {
                     mostrarModalConfirmacao('Erro', 'Nenhum guichê está configurado para exibição nesta aba. Vá para Configurações > Guichês.', () => {});
                    return;
                }
                const atendimentos = (estadoLocal && estadoLocal.atendimentosAtuais) ? estadoLocal.atendimentosAtuais : {};
                const guicheLivre = meusGuiches.find(nome => !atendimentos[nome]);

                if (!guicheLivre) {
                    mostrarModalConfirmacao('Atenção', 'Todos os seus guichês de exibição estão ocupados. Finalize um atendimento antes de chamar uma senha manualmente.', () => {});
                    return;
                }
                const numeroSenha = $(this).data('senha-numero');
                if (!numeroSenha) return;
                
                console.log(`Solicitando chamada manual de ${numeroSenha} para ${guicheLivre}`);
                socket.emit('chamarSenhaEspecifica', { 
                    guicheId: guicheLivre, 
                    numeroSenha: numeroSenha 
                });
            });

            $tabStats.on('click', '.btn-acao-excluir', function() {
                // Lógica copiada do handler de $listaEspera
                const numeroSenha = $(this).data('senha-numero');
                if (!numeroSenha) return;
                mostrarModalConfirmacao(
                    'Excluir Senha', 
                    `Tem certeza que deseja excluir a senha <strong>${numeroSenha}</strong> da fila?`, 
                    function() {
                        socket.emit('excluirSenha', { 
                            numeroSenha: numeroSenha 
                        });
                    }
                );
            });
            
            $tabStats.on('click', '.btn-acao-editar', function() {
                // Lógica copiada do handler de $listaEspera
                const numeroSenha = $(this).data('senha-numero');
                const senhas = (estadoLocal && estadoLocal.senhas) ? estadoLocal.senhas : [];
                const senha = senhas.find(s => s.numero === numeroSenha);
                if (senha) {
                    $('#modal-editar-titulo').text(`Editar Descrição (${senha.numero})`);
                    $('#hidden-editar-senha-numero').val(senha.numero);
                    $('#textarea-editar-descricao').val(senha.descricao || '');
                    $modalEditarDescricao.css('display', 'flex');
                }
            });

            // *** NOVO (Req 3): Handler para botão DEVOLVER na aba de stats ***
            $tabStats.on('click', '.btn-acao-devolver', function() {
                const numeroSenha = $(this).data('senha-numero');
                if (!numeroSenha) return;
                
                mostrarModalConfirmacao(
                    'Devolver à Fila', 
                    `Tem certeza que deseja devolver a senha <strong>${numeroSenha}</strong> para a fila de espera?`, 
                    function() {
                        socket.emit('devolverSenha', { 
                            numeroSenha: numeroSenha 
                        });
                    }
                );
            });
            // --- FIM: NOVOS HANDLERS ---

            // --- NOVO: Handler para botão info nos atendimentos atuais ---
            $listaAtendimentosAtuais.on('click', '.btn-acao-info', function() {
                const numeroSenha = $(this).data('senha-numero');
                if (!numeroSenha) return;

                // Abre as abas corretas
                $('.tab-link[data-tab="tab-stats"]').trigger('click');
                $('.sub-tab-link[data-sub-tab="sub-tab-ticket"]').trigger('click');
                
                // Define e renderiza
                ticketInfoSendoExibido = numeroSenha;
                renderizarDetalhesDoTicket(numeroSenha);
            });

            // --- Lógica do Modal de Edição ---
            $('#btn-salvar-descricao').on('click', function() {
                const numeroSenha = $('#hidden-editar-senha-numero').val();
                const descricao = $('#textarea-editar-descricao').val().trim();
                if (numeroSenha) {
                    socket.emit('atualizarDescricao', { numeroSenha: numeroSenha, descricao: descricao });
                    $modalEditarDescricao.css('display', 'none');
                }
            });
            $('#btn-fechar-modal-editar').on('click', function() {
                $modalEditarDescricao.css('display', 'none');
            });
            
            // --- Event Listener para "Não-Compareceu" (Lista "Atendendo") ---
            $listaAtendimentosAtuais.on('click', '.btn-excluir-atendimento', function() {
                const numeroSenha = $(this).data('senha-numero');
                if (!numeroSenha) return;
                const texto = `Tem certeza que deseja marcar a senha <strong>${numeroSenha}</strong> como NÃO-COMPARECEU?<br><br>Esta ação irá removê-la do atendimento e das estatísticas, mas manterá o total de senhas emitidas.`;
                mostrarModalConfirmacao(
                    'Confirmar Não-Comparecimento', 
                    texto,
                    function() {
                        socket.emit('excluirAtendimento', { 
                            numeroSenha: numeroSenha 
                        });
                    }
                );
            });


            // --- Lógica de Comunicação com Servidor ---

            // *** ATUALIZADO: Recebe o payload combinado {estado, estatisticas} ***
            socket.on('estadoAtualizado', (payload) => {
                console.log('Recebido novo estado do servidor:', payload);
                
                // Salva o estado local (para filas, etc.)
                estadoLocal = payload.estado || {}; 
                // *** NOVO: Salva estatísticas locais ***
                estatisticasLocais = payload.estatisticas || {}; 
                // *** NOVO: Salva guichês globais ***
                guichesGlobais = estadoLocal.guichesConfigurados || [];
                
                // Atualiza proporções na UI
                $inputRatio.val(estadoLocal.proporcaoPrioridade || 2);
                $inputRatioContratual.val(estadoLocal.proporcaoContratual || 1);

                // *** ATUALIZADO (Req 2): Lógica de renderização condicional para evitar perda de foco ***
                const $focusedInput = $('#guiche-global-list input:focus');
                
                if ($focusedInput.length) {
                    // Usuário está digitando. Não renderiza a lista global (que causa perda de foco).
                    // Mas renderiza a lista de "Exibição" (checkboxes) para feedback em tempo real.
                    renderizarGuichesExibicao(); 
                } else {
                    // Ninguém está digitando, seguro renderizar a lista global.
                    renderizarGuichesGlobais();
                }
                // *** FIM DA ATUALIZAÇÃO (Req 2) ***

                // Chama a função principal de atualização, passando as estatísticas
                atualizarInterface(payload.estatisticas || {});
            });


            socket.on('beep', (dados) => {
                beep(dados.times);
                if (dados.tipo === 'emissao') {
                    $('#senha-gerada-numero').text(dados.numero);
                    $('#hidden-nova-senha-numero').val(dados.numero); 
                    $('#textarea-nova-senha-descricao').val(''); 
                    $('#form-group-nova-senha').hide(); 
                    descricaoAtiva = false; 
                    
                    $modalNovaSenha.css('display', 'flex');
                    $('body').css('overflow', 'hidden'); 
                }
            });

            socket.on('sistemaReiniciado', () => {
                // *** ATUALIZADO: Limpa o sessionStorage da aba atual ao reiniciar ***
                sessionStorage.removeItem('sgfGuichesExibicao');
                window.location.reload();
            });
            

            // --- Funções de Interface ---
            
            // --- ATUALIZADO: Função dedicada para renderizar a Fila de Espera ---
            function renderizarFilaDeEspera() {
                if (!estadoLocal.senhas) {
                    $listaEspera.empty().append('<div class="senha-item">Nenhuma senha na fila</div>');
                    return;
                }

                let senhasEspera = estadoLocal.senhas.filter(s => s.status === 'espera');

                // 1. Aplicar Filtro de Busca
                if (termoBusca) {
                    senhasEspera = senhasEspera.filter(s => 
                        s.descricao && s.descricao.toLowerCase().includes(termoBusca)
                    );
                }

                // 2. Aplicar Filtro de Ordenação
                switch (filtroAtivo) {
                    case 'emissao':
                        // Padrão: Ordem de chegada (timestamp)
                        senhasEspera.sort((a, b) => a.timestamp - b.timestamp);
                        break;
                    
                    // ================================================================
                    // =========   NOVA LÓGICA DE SIMULAÇÃO (AUTOMÁTICA)   ==========
                    // ================================================================
                    case 'automatica':
                        const filaSimulada = [];
                        // Criamos cópias virtuais da fila e dos contadores
                        let simFilaEspera = [...senhasEspera].sort((a, b) => a.timestamp - b.timestamp);
                        // *** ATUALIZADO: Usa estadoLocal ***
                        let simContadorP = estadoLocal.contadorPrioridadeDesdeUltimaNormal || 0;
                        let simContadorC = estadoLocal.contadorContratualDesdeUltimaNormal || 0;
                        const proporcaoP = estadoLocal.proporcaoPrioridade || 2;
                        const proporcaoC = estadoLocal.proporcaoContratual || 1;

                        // Loop roda enquanto houver senhas na fila virtual
                        while (simFilaEspera.length > 0) {
                            // Encontra as mais antigas de cada tipo na fila *restante*
                            const prioritariaMaisAntiga = simFilaEspera.find(s => s.tipo === 'prioridade');
                            const contratualMaisAntiga = simFilaEspera.find(s => s.tipo === 'contratual');
                            const normalMaisAntiga = simFilaEspera.find(s => s.tipo === 'normal');
                            
                            let proximaSimulada = null;

                            // Exatamente a mesma lógica do server.js
                            if (prioritariaMaisAntiga && simContadorP < proporcaoP) {
                                proximaSimulada = prioritariaMaisAntiga;
                                simContadorP++; 
                            }
                            else if (contratualMaisAntiga && simContadorC < proporcaoC) {
                                proximaSimulada = contratualMaisAntiga;
                                simContadorC++;
                            }
                            else if (normalMaisAntiga) {
                                proximaSimulada = normalMaisAntiga;
                                simContadorP = 0; // Reseta contadores
                                simContadorC = 0;
                            }
                            else if (prioritariaMaisAntiga) {
                                // Fallback P (esgotou normais, mas P ainda existe)
                                proximaSimulada = prioritariaMaisAntiga;
                                simContadorP++;
                            }
                            else if (contratualMaisAntiga) {
                                // Fallback C (esgotou P e N, mas C ainda existe)
                                proximaSimulada = contratualMaisAntiga;
                                simContadorC++; 
                            }
                            
                            if (proximaSimulada) {
                                // Adiciona o item encontrado à nossa fila ordenada
                                filaSimulada.push(proximaSimulada);
                                // Remove o item da fila virtual para o próximo loop
                                simFilaEspera = simFilaEspera.filter(s => s.numero !== proximaSimulada.numero);
                            } else {
                                // Se não encontrar ninguém (fila vazia ou bug), para o loop
                                break; 
                            }
                        }
                        
                        // A fila renderizada será a fila simulada
                        senhasEspera = filaSimulada;
                        break;
                    // ================================================================
                    // =================   FIM DA NOVA LÓGICA   =======================
                    // ================================================================

                    case 'tipo':
                        // Apenas agrupa por tipo (P > C > N) e depois por chegada
                        senhasEspera.sort((a, b) => {
                            if (tipoValor[a.tipo] !== tipoValor[b.tipo]) {
                                return tipoValor[a.tipo] - tipoValor[b.tipo];
                            }
                            return a.timestamp - b.timestamp;
                        });
                        break;
                }

                // 3. Renderizar no DOM
                $listaEspera.empty();
                if (senhasEspera.length > 0) {
                    senhasEspera.forEach(senha => {
                        let classe, icone;
                        
                        if (senha.tipo === 'prioridade') {
                            classe = 'prioridade';
                            icone = 'fas fa-wheelchair';
                        } else if (senha.tipo === 'contratual') {
                            classe = 'contratual';
                            icone = 'fas fa-file-contract';
                        } else {
                            classe = 'normal';
                            icone = 'fas fa-user';
                        }
                        
                        let descricaoHtml = '';
                        if (senha.descricao) {
                            const descricaoEscapada = $('<div />').text(senha.descricao).html().replace(/\n/g, '<br>');
                            descricaoHtml = `<div class="senha-item-descricao">${descricaoEscapada}</div>`;
                        }

                        // --- MODIFICADO: Req 3 (Rótulo de Fila) - Removido o <span class="badge ..."> ---
                        $listaEspera.append(`
                            <div class="senha-item ${classe}" data-senha-numero="${senha.numero}">
                                <div>
                                    <i class="${icone}"></i> 
                                    <strong>${senha.numero}</strong>
                                    ${descricaoHtml}
                                </div>
                                
                                <div class="senha-item-controles">
                                    <span>${calcularTempoEspera(senha.timestamp)} min</span>
                                    <div class="botoes-wrapper">
                                        <button class="btn-acao-senha btn-acao-info" data-senha-numero="${senha.numero}" title="Ver Detalhes">
                                            <i class="fas fa-info-circle"></i>
                                        </button>
                                        <button class="btn-acao-senha btn-acao-chamar" data-senha-numero="${senha.numero}" title="Chamar esta senha">
                                            <i class="fas fa-bullhorn"></i>
                                        </button>
                                        <button class="btn-acao-senha btn-acao-editar" data-senha-numero="${senha.numero}" title="Editar Descrição">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn-acao-senha btn-acao-excluir" data-senha-numero="${senha.numero}" title="Excluir esta senha">
                                            <i class="fas fa-trash-alt"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `);
                    });
                } else {
                     if (termoBusca) {
                        $listaEspera.append('<div class="senha-item">Nenhuma senha encontrada com essa descrição.</div>');
                    } else {
                        $listaEspera.append('<div class="senha-item">Nenhuma senha na fila</div>');
                    }
                }
            }


            // --- ATUALIZADO: Função principal de renderização ---
            // *** Recebe as 'estatisticas' calculadas do servidor ***
            function atualizarInterface(estatisticas) {
                
                // Garante que temos dados locais
                const senhas = (estadoLocal && estadoLocal.senhas) ? estadoLocal.senhas : [];
                const atendimentos = (estadoLocal && estadoLocal.atendimentosAtuais) ? estadoLocal.atendimentosAtuais : {};

                // 1. Renderiza os painéis de guichê dinâmicos (usa estadoLocal)
                renderizarPaineisDeGuiche();
                
                // 2. Renderiza a Fila de Espera (usa estadoLocal)
                renderizarFilaDeEspera();
                
                // 3. Renderiza Atendimentos Atuais (usa estadoLocal)
                $listaAtendimentosAtuais.empty();
                const senhasEmAtendimento = senhas.filter(s => s.status === 'chamada');
                
                if (senhasEmAtendimento.length > 0) {
                    senhasEmAtendimento.forEach(senha => {
                        let classe = 'normal';
                        if (senha.tipo === 'prioridade') classe = 'prioridade';
                        if (senha.tipo === 'contratual') classe = 'contratual';
                        
                        $listaAtendimentosAtuais.append(`
                            <div class="senha-item ${classe}">
                                <div>
                                    <i class="fas fa-user-headset"></i> 
                                    <strong>${senha.numero}</strong>
                                    <span style="font-weight: normal; margin-left: 10px; color: #555;">(${senha.guicheAtendendo})</span>
                                </div>
                                
                                <div class="senha-item-controles">
                                    <div class="botoes-wrapper">
                                        <button class="btn-acao-senha btn-acao-info" data-senha-numero="${senha.numero}" title="Ver Detalhes">
                                            <i class="fas fa-info-circle"></i>
                                        </button>
                                        <button class="btn-acao-senha btn-acao-devolver" data-senha-numero="${senha.numero}" title="Devolver à Fila">
                                            <i class="fas fa-undo"></i>
                                        </button>
                                        <button class="btn-acao-senha btn-acao-excluir btn-excluir-atendimento" data-senha-numero="${senha.numero}" title="Excluir Atendimento (Não-Compareceu)">
                                            <i class="fas fa-user-slash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `);
                    });
                } else {
                    $listaAtendimentosAtuais.append('<div class="senha-item">Nenhum atendimento em andamento</div>');
                }
                
                // *** 4. ATUALIZADO (Req 4): Renderiza Histórico (usa estadoLocal) ***
                const senhasAtendidas = senhas.filter(s => s.status === 'atendida');
                $historicoAtendimentos.empty();
                
                if (senhasAtendidas.length > 0) {
                    // Pega as últimas 10 (ou todas, se menos de 10) e inverte (mais recente primeiro)
                    const ultimasSenhas = senhasAtendidas.slice(-10).reverse(); 
                    
                    ultimasSenhas.forEach(senha => {
                        let classe, icone;
                        
                        if (senha.tipo === 'prioridade') {
                            classe = 'prioridade';
                            icone = 'fas fa-wheelchair';
                        } else if (senha.tipo === 'contratual') {
                            classe = 'contratual';
                            icone = 'fas fa-file-contract';
                        } else {
                            classe = 'normal';
                            icone = 'fas fa-user';
                        }
                        
                        let descricaoHtml = '';
                        if (senha.descricao) {
                            const descricaoEscapada = $('<div />').text(senha.descricao).html().replace(/\n/g, '<br>');
                            descricaoHtml = `<div class="senha-item-descricao">${descricaoEscapada}</div>`;
                        }

                        // --- NOVO (Req 4): Botões para o histórico (copiado da fila de espera) ---
                        const botoesHtml = `
                            <div class="botoes-wrapper">
                                <button class="btn-acao-senha btn-acao-info" data-senha-numero="${senha.numero}" title="Ver Detalhes">
                                    <i class="fas fa-info-circle"></i>
                                </button>
                                <button class="btn-acao-senha btn-acao-chamar" data-senha-numero="${senha.numero}" title="Chamar esta senha">
                                    <i class="fas fa-bullhorn"></i>
                                </button>
                                <button class="btn-acao-senha btn-acao-editar" data-senha-numero="${senha.numero}" title="Editar Descrição">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn-acao-senha btn-acao-excluir" data-senha-numero="${senha.numero}" title="Excluir esta senha">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </div>
                        `;
                        // --- FIM: Botões para o histórico ---

                        // --- NOVO (Req 4): Texto de tempo de atendimento ---
                        const tempoAtendimentoFormatado = formatarTempo(senha.tempoAtendimento);
                        const guicheQueAtendeu = senha.guicheAtendendo || 'Guichê';
                        
                        $historicoAtendimentos.append(`
                            <div class="senha-item ${classe}" data-senha-numero="${senha.numero}">
                                <div>
                                    <i class="${icone}"></i> 
                                    <strong>${senha.numero}</strong>
                                    ${descricaoHtml}
                                </div>
                                
                                <div class="senha-item-controles">
                                    <span title="Atendido por ${guicheQueAtendeu} em ${tempoAtendimentoFormatado}">
                                        ${tempoAtendimentoFormatado}
                                    </span>
                                    ${botoesHtml}
                                </div>
                            </div>
                        `);
                    });
                } else {
                    $historicoAtendimentos.append('<div class="senha-item">Nenhum atendimento registrado</div>');
                }
                // *** FIM DA ATUALIZAÇÃO (Req 4) ***
                
                // 5. Renderiza Estatísticas (usa o objeto 'estatisticas' recebido)
                $totalSenhas.text(estatisticas.totalEmitidas || 0);
                $senhasAtendidas.text(estatisticas.totalAtendidas || 0);
                $tempoMedio.text(estatisticas.tempoMedioEsperaGeral || '0 min');
                $proximaSenha.text(estatisticas.proximaSenha || '---');
                
                $totalNaoCompareceu.text(estatisticas.totalNaoCompareceu || 0);
                $totalExcluidas.text(estatisticas.totalExcluidas || 0);

                // 6. Renderiza Tabela por Tipo
                $statsPorTipo.empty();
                const tipos = [
                    { key: 'prioridade', nome: 'Prioritária' },
                    { key: 'contratual', nome: 'Contratual' },
                    { key: 'normal', nome: 'Normal' }
                ];
                
                tipos.forEach(tipo => {
                    // --- ATUALIZADO: Inclui valores padrão para os novos campos ---
                    const dados = (estatisticas.detalhesPorTipo && estatisticas.detalhesPorTipo[tipo.key]) 
                                ? estatisticas.detalhesPorTipo[tipo.key] 
                                : { emitidas: 0, atendidas: 0, tempoMedioEspera: '0 min', tempoMedioAtendimento: '0 min', maiorTempoEspera: '0 min', menorTempoEspera: '---' };
                    
                    // --- ATUALIZADO: Renderiza as novas colunas ---
                    $statsPorTipo.append(`
                        <tr data-tipo="${tipo.key}">
                            <td>${tipo.nome}</td>
                            <td>${dados.emitidas}</td>
                            <td>${dados.atendidas}</td>
                            <td>${dados.tempoMedioEspera}</td>
                            <td>${dados.tempoMedioAtendimento}</td>
                            <td>${dados.maiorTempoEspera}</td>
                            <td>${dados.menorTempoEspera}</td>
                        </tr>
                    `);
                });

                // 7. Renderiza Desempenho por Guichê
                $statsPorGuiche.empty();
                if (estatisticas.detalhesPorGuiche && Object.keys(estatisticas.detalhesPorGuiche).length > 0) {
                    Object.keys(estatisticas.detalhesPorGuiche).sort().forEach(guicheNome => {
                        const dados = estatisticas.detalhesPorGuiche[guicheNome];
                        $statsPorGuiche.append(`
                            <div class="stat-item">
                                <span>${guicheNome}</span>
                                <span><strong>${dados.atendidas}</strong> atendidas (TMA: ${dados.tempoMedioAtendimento})</span>
                            </div>
                        `);
                    });
                } else {
                    $statsPorGuiche.append('<div class="stat-item">Nenhum guichê finalizou atendimentos.</div>');
                }
                
                // *** 8. NOVO: Re-renderiza detalhes do ticket se estiver sendo exibido ***
                if (ticketInfoSendoExibido) {
                    // Re-renderiza usando o estado e estatisticas mais recentes
                    renderizarDetalhesDoTicket(ticketInfoSendoExibido); 
                }
            }
            
            function calcularTempoEspera(timestamp) {
                const agora = new Date().getTime();
                return Math.round((agora - timestamp) / 60000);
            }
            
            // --- ATUALIZADO: Função de formatação de tempo (substitui formatarTempoMedio) ---
            function formatarTempo(milissegundos) {
                if (isNaN(milissegundos) || milissegundos === 0 || !isFinite(milissegundos)) {
                    // Retorna "0 min" se for NaN, 0, ou Infinity (ex: divisão por zero)
                    return '0 min';
                }
                if (milissegundos < 60000) return "< 1 min";
                const minutos = Math.round(milissegundos / 60000);
                return `${minutos} min`;
            }
            
            function beep(times = 1) {
                try {
                    for (let i = 0; i < times; i++) {
                        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                        const oscillator = audioContext.createOscillator();
                        const gainNode = audioContext.createGain();
                        
                        oscillator.connect(gainNode);
                        gainNode.connect(audioContext.destination);
                        
                        oscillator.type = 'sine';
                        oscillator.frequency.value = times === 1 ? 800 : 1000;
                        gainNode.gain.value = 0.1;
                        
                        oscillator.start();
                        setTimeout(() => {
                            oscillator.stop();
                        }, 200);
                    }
                } catch (e) {
                    console.log('Áudio não suportado');
                }
            }
            
            setInterval(() => {
                // *** ATUALIZADO: Usa estadoLocal ***
                if (estadoLocal.senhas && estadoLocal.senhas.length > 0) {
                    // ATUALIZADO: Chama a função de renderizar fila para atualizar os tempos
                    renderizarFilaDeEspera();
                }
            }, 60000); // Atualiza os tempos de espera a cada minuto
            
            // --- NOVO: Inicialização da exibição de guichês ---
            // Renderiza os checkboxes E os painéis de controle da aba atual ao carregar
            renderizarGuichesExibicao();
            renderizarPaineisDeGuiche();
            
        });
        // --- DEEPSEEK ---
    </script>
</body>
</html>